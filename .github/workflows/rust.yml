name: Rust
on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

# Cancel in-progress runs on same branch/PR
concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always

jobs:
    format:
        name: Check format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                shared-key: "format"
            - name: Check format
              run: cargo fmt -- --check

    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                shared-key: "lint"
            - name: Lint all targets
              run: cargo clippy --all-targets --all-features -- -D warnings

    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                shared-key: "build"
            - name: Build all binaries
              run: cargo build --verbose --all-targets

    build-release:
        name: Build Release
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                shared-key: "release"
            - name: Build release binaries
              run: cargo build --release --all-targets
            - name: Verify grain binary exists
              run: test -f target/release/grain
            - name: Verify grainctl binary exists
              run: test -f target/release/grainctl
            - name: Upload grain binary
              uses: actions/upload-artifact@v4
              with:
                  name: grain-binary
                  path: target/release/grain
            - name: Upload grainctl binary
              uses: actions/upload-artifact@v4
              with:
                  name: grainctl-binary
                  path: target/release/grainctl

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                shared-key: "test"
            - name: Run unit tests
              run: cargo test --verbose --all-targets
            - name: Run integration tests
              run: cargo test --verbose --test '*'

    e2e-test:
        name: E2E Tests
        runs-on: ubuntu-latest
        needs: build-release
        steps:
            - uses: actions/checkout@v4
            - name: Download grain binary
              uses: actions/download-artifact@v4
              with:
                  name: grain-binary
                  path: target/release
            - name: Download grainctl binary
              uses: actions/download-artifact@v4
              with:
                  name: grainctl-binary
                  path: target/release
            - name: Make binaries executable
              run: |
                chmod +x target/release/grain
                chmod +x target/release/grainctl
            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                shared-key: "e2e-test"
            - name: Run E2E tests (without Docker)
              run: cargo test --verbose --test '*' -- --test-threads=1
            - name: Run Docker client tests
              run: cargo test --verbose --test docker_client --features docker-tests -- --test-threads=1
              continue-on-error: true
            - name: Upload test logs on failure
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: e2e-test-logs
                  path: |
                      target/debug/
                      /tmp/grain-test-*/
                  retention-days: 3

    integration-test:
        name: Integration Test
        runs-on: ubuntu-latest
        needs: build-release
        steps:
            - uses: actions/checkout@v4
            - name: Download grain binary
              uses: actions/download-artifact@v4
              with:
                  name: grain-binary
                  path: target/release
            - name: Download grainctl binary
              uses: actions/download-artifact@v4
              with:
                  name: grainctl-binary
                  path: target/release
            - name: Make binaries executable
              run: |
                chmod +x target/release/grain
                chmod +x target/release/grainctl
            - name: Create test users file
              run: |
                  mkdir -p tmp
                  cat > tmp/users.json << 'EOF'
                  {
                    "users": [
                      {
                        "username": "admin",
                        "password": "admin",
                        "permissions": [{"repository": "*", "tag": "*", "actions": ["pull", "push", "delete"]}]
                      }
                    ]
                  }
                  EOF
            - name: Start grain server
              run: |
                  ./target/release/grain --host 127.0.0.1:8888 --users-file ./tmp/users.json &
                  sleep 3
            - name: Test server is running
              run: curl -f -u admin:admin http://127.0.0.1:8888/v2/
            - name: Test grainctl list users
              run: ./target/release/grainctl user list --url http://127.0.0.1:8888 --username admin --password admin
            - name: Test grainctl create user
              run: ./target/release/grainctl user create testuser --pass testpass --url http://127.0.0.1:8888 --username admin --password admin
            - name: Test grainctl add permission
              run: ./target/release/grainctl user add-permission testuser --repository "test/*" --tag "*" --actions "pull" --url http://127.0.0.1:8888 --username admin --password admin
            - name: Test grainctl delete user
              run: ./target/release/grainctl user delete testuser --url http://127.0.0.1:8888 --username admin --password admin
            - name: Stop server
              run: pkill -f "grain.*--host" || true
